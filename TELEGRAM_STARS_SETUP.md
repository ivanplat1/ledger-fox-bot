# Настройка оплаты через Telegram Stars

## Что такое Telegram Stars?

Telegram Stars - это внутренняя валюта Telegram для оплаты подписок и услуг в ботах. Пользователи могут покупать Stars через Telegram и использовать их для оплаты.

**Курс:** 1 Star ≈ $0.01 (1 цент)

## Текущая реализация

### Тарифы

1. **Trial (пробный период)** — бесплатно
   - 10 чеков бесплатно
   - Все базовые функции
   - Отчеты и экспорт

2. **Pro** — 200 ⭐/месяц (~$2.00)
   - 100 чеков в месяц
   - Все функции бота
   - Приоритетная поддержка

3. **Premium** — 500 ⭐/месяц (~$5.00)
   - Безлимит чеков
   - Все функции бота
   - Максимальная поддержка
   - Ранний доступ к новым фичам

### Как это работает

1. **Пользователь вызывает `/subscribe`**
   - Бот показывает биллборд с тарифами
   - Пользователь выбирает тариф (Pro или Premium)
   - Бот отправляет счет на оплату

2. **Отправка счета (`send_invoice`)**
   - Валюта: `XTR` (Telegram Stars)
   - Сумма: 200 Stars для Pro, 500 Stars для Premium
   - Описание: выбранный тариф на 1 месяц

3. **Предварительная проверка (`pre_checkout_query`)**
   - Бот автоматически подтверждает платеж

4. **Успешная оплата (`successful_payment`)**
   - Активируется выбранная подписка на 1 месяц
   - Лимит устанавливается в зависимости от тарифа (100 для Pro, безлимит для Premium)
   - Счетчик чеков сбрасывается

## Настройка бота для приема платежей

### 1. Настройка Telegram Stars

**Важно:** Для Telegram Stars **не требуется** дополнительная настройка в BotFather!

Telegram Stars работает автоматически для всех ботов при использовании:
- Валюты `XTR` в методе `send_invoice`
- Правильного формата вызова API

**Что НЕ нужно делать:**
- ❌ Не нужно включать "Enable Payments" в BotFather (такой опции нет для Stars)
- ❌ Не нужно настраивать платежного провайдера
- ❌ Не нужен `provider_token` для Stars

**Что нужно:**
- ✅ Просто использовать валюту `"XTR"` в `send_invoice`
- ✅ Указать цену в Stars (например, 200 Stars)

### 2. Проверка работы

Просто запустите бота и используйте команду `/subscribe`:
- Бот отправит счет на оплату через Telegram Stars
- Пользователи смогут оплатить через Telegram Stars
- После оплаты подписка активируется автоматически

### 3. Если платежи не работают

Если при вызове `/subscribe` возникает ошибка:
1. Убедитесь, что бот использует актуальную версию Bot API
2. Проверьте, что валюта указана как `"XTR"` (не "USD", "RUB" и т.д.)
3. Убедитесь, что цена указана в Stars (например, 200 для 200 Stars)
4. Проверьте логи бота на наличие ошибок
5. Убедитесь, что у пользователя есть Stars в Telegram

## Тестирование

Для тестирования оплаты:
1. Используйте тестовый режим BotFather (если доступен)
2. Или используйте реальные Stars для тестирования

## Структура данных

Подписка сохраняется в таблице `user_limits`:
- `subscription_type`: `"trial"`, `"pro"` или `"premium"`
- `limit_receipts`: `10` для trial, `100` для pro, `NULL` для premium (безлимит)
- `expires_at`: дата окончания подписки (через 30 дней, `NULL` для trial)
- `receipts_count`: сбрасывается в `0` при активации подписки

## Комиссия Telegram

Telegram берет комиссию с платежей через Stars:
- Комиссия зависит от региона и может варьироваться
- Учитывайте комиссию при установке цены подписки

## Дополнительные возможности

В будущем можно добавить:
- Подписки на 3/6/12 месяцев со скидкой
- Пожизненная подписка (unlimited)
- Промокоды и скидки
- История платежей пользователя

