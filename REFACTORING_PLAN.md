# План рефакторинга ExpenseCatBot

## Проблема
При изменении одной части кода ломается другая из-за тесной связанности логики.

## Решение
Разделение логики на изолированные модули в папке `handlers/`.

## Созданные модули

### ✅ `handlers/report_handler.py`
- Логика обработки отчетов
- Выбор периода и валюты
- Формирование клавиатур для выбора валюты

### ✅ `handlers/report_formatter.py`
- Форматирование текстовых отчетов
- Поддержка мультивалютных отчетов
- Форматирование дат и периодов

### ✅ `handlers/expense_handler.py`
- Парсинг ручных расходов
- Подтверждение расходов
- Сохранение расходов

### ⏳ `handlers/receipt_handler.py` (TODO)
- Обработка чеков
- Распознавание QR-кодов
- Генерация изображений чеков

### ⏳ `handlers/statement_handler.py` (TODO)
- Обработка банковских выписок
- Парсинг CSV/PDF/XLSX
- Импорт транзакций

## Исправленные ошибки

### ✅ Исправлена ошибка с валютами в отчетах
**Проблема**: Код обработки категорий был вне цикла по валютам, из-за чего `currencies_data` формировался неправильно.

**Исправление**: Весь код обработки категорий, магазинов и дней перенесен внутрь цикла `for currency, currency_data in data_by_currency.items()`.

**Файл**: `expense_cat_bot.py`, строки 1215-1278

## Следующие шаги

1. **Интеграция модулей в основной файл** (постепенно):
   - Заменить обработчики отчетов на использование `ReportHandler` и `ReportFormatter`
   - Заменить обработчики расходов на использование `ExpenseHandler`
   - Создать и интегрировать `ReceiptHandler` и `StatementHandler`

2. **Тестирование**:
   - Проверить работу отчетов с несколькими валютами
   - Проверить работу ручных расходов
   - Проверить работу чеков и выписок

3. **Дальнейшая изоляция**:
   - Вынести общие утилиты в `utils.py`
   - Вынести константы в `constants.py`
   - Вынести типы данных в `types.py`

## Преимущества рефакторинга

- ✅ Изоляция логики - изменения в одном модуле не влияют на другие
- ✅ Упрощение тестирования - каждый модуль можно тестировать отдельно
- ✅ Улучшение читаемости - код разбит на логические части
- ✅ Упрощение отладки - легче найти проблему в конкретном модуле

